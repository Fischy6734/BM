<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Schedule</title>
  <style>
    :root {
      --primary-bg: #20242a;
      --secondary-bg: #252a33;
      --accent: #2b8af7;
      --block-bg: #23272e;
      --dot-green: #41c65b;
      --dot-orange: #f5a623;
      --dot-red: #f44336;
      --focus: #e3e3e3;
      --progress-bar: #2b8af7;
      --block-progress-bg: #2c3139;
      --block-progress-fill: #41c65b;
      --rainbow: none;
      --fancy-glow: none;
    }
    body {
      font-family: system-ui, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(120deg, #191c22 60%, #23272e 100%);
      color: #e3e3e3;
      margin: 0;
      padding: 0;
      transition: background 0.4s, color 0.4s;
    }
    body.light {
      background: #f5f7fa;
      color: #23272e;
    }
    .container {
      max-width: 700px;
      margin: 30px auto;
      padding: 28px 22px 18px 22px;
      background: var(--primary-bg);
      border-radius: 14px;
      box-shadow: 0 2px 12px 0 rgba(20,24,32,0.27);
      position: relative;
      transition: background 0.4s;
    }
    body.light .container {
      background: #fff;
      color: #23272e;
      box-shadow: 0 2px 12px 0 #e5e8ec;
    }
    .theme-switcher {
      position: absolute;
      top: 24px;
      right: 30px;
      background: var(--block-bg);
      border: none;
      padding: 7px 18px;
      border-radius: 7px;
      color: var(--accent);
      font-size: 1em;
      cursor: pointer;
      font-weight: 600;
      box-shadow: none;
      transition: background 0.3s, color 0.3s;
    }
    body.light .theme-switcher {
      background: #e9ecf3;
      color: #222;
    }
    h1 {
      text-align: center;
      margin-bottom: 28px;
      font-size: 2.6rem;
      color: var(--accent);
      letter-spacing: 2px;
      text-shadow: none;
      font-weight: 700;
      background: none;
      -webkit-background-clip: unset;
      -webkit-text-fill-color: unset;
      background-clip: unset;
    }
    .progress-bar-container {
      width: 100%;
      background: #242a33;
      height: 14px;
      border-radius: 7px;
      margin-bottom: 18px;
      overflow: hidden;
      position: relative;
      box-shadow: none;
    }
    body.light .progress-bar-container {
      background: #e0e3ee;
    }
    .progress-bar {
      height: 100%;
      background: var(--progress-bar);
      width: 0%;
      transition: width 0.7s cubic-bezier(.44,2,.28,1);
      box-shadow: none;
    }
    .encouragement {
      text-align: center;
      margin: 14px 0 0 0;
      font-size: 1.18rem;
      font-weight: 600;
      color: var(--accent);
      min-height: 1.5em;
      letter-spacing: 1px;
      transition: color 0.2s;
      user-select: none;
      text-shadow: none;
      animation: none;
      opacity: 0.92;
    }
    .schedule-header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: inherit;
      padding: 12px 0 8px 0;
      font-size: 1.13rem;
      color: #7fa9ce;
      font-weight: 600;
      border-bottom: 1px solid #2d343e;
      margin-bottom: 8px;
    }
    .schedule {
      margin-bottom: 25px;
    }
    .block {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      background: var(--block-bg);
      padding: 14px 18px;
      border-radius: 9px;
      box-shadow: 0 1px 4px #0001;
      font-size: 1.16rem;
      transition: background 0.2s;
      position: relative;
      border-left: 5px solid transparent;
      border-bottom: 1px solid #23272e;
    }
    body.light .block {
      background: #f6f8fa;
      border-bottom: 1px solid #e2e5f1;
    }
    .block:hover, .block:focus-within {
      background: var(--secondary-bg);
      border-left: 5px solid var(--accent);
      box-shadow: 0 3px 12px #2b8af711;
      z-index: 2;
    }
    body.light .block:hover, body.light .block:focus-within {
      background: #e3e8ee;
    }
    .block-time {
      font-size: 1.05em;
      color: #7fa9ce;
      margin-left: 7px;
      font-family: system-ui, 'Segoe UI', Arial, sans-serif;
      letter-spacing: 1px;
      font-weight: 600;
    }
    .notes-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 0.97em;
      padding: 3px 10px;
      margin-left: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
      box-shadow: none;
    }
    .notes-btn:hover {
      background: #1664bb;
      color: #fff;
    }
    .notes-modal-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(26,28,32,0.50);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .notes-modal {
      background: #22262c;
      color: #e3e3e3;
      border-radius: 12px;
      padding: 25px 24px 18px 24px;
      min-width: 300px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.16);
      max-width: 90vw;
      border: 2px solid #232a30;
    }
    .notes-modal h2 {
      margin: 0 0 14px 0;
      font-size: 1.2rem;
      color: var(--accent);
    }
    .notes-modal textarea {
      width: 100%;
      min-height: 60px;
      border-radius: 6px;
      border: 1px solid #475065;
      font-size: 1.05em;
      padding: 7px;
      margin-bottom: 12px;
      resize: vertical;
      background: #23272e;
      color: #e3e3e3;
    }
    .notes-modal .close-notes {
      background: #f44336;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 0.97em;
      padding: 4px 12px;
      margin-right: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .notes-modal .save-notes {
      background: #41c65b;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 0.97em;
      padding: 4px 12px;
      cursor: pointer;
      font-weight: 600;
    }
    .notes-indicator {
      margin-left: 7px;
      font-size: 1.05em;
      color: #41c65b;
      vertical-align: middle;
    }
    .status {
      margin-top: 20px;
      padding: 10px;
      background: var(--block-bg);
      border-radius: 8px;
      box-shadow: 0 1px 3px #0001;
      position: relative;
      z-index: 1;
    }
    body.light .status {
      background: #f6f8fa;
    }
    .status h2 {
      font-size: 1.25rem;
      color: var(--accent);
      margin: 0 0 12px 0;
      border-bottom: 1px solid #2d343e;
      padding-bottom: 4px;
    }
    .status-block {
      display: flex;
      align-items: center;
      margin-bottom: 9px;
      font-size: 1.06rem;
      letter-spacing: 0.5px;
      position: relative;
    }
    .dot {
      width: 19px;
      height: 19px;
      margin-right: 13px;
      border-radius: 50%;
      display: inline-block;
      position: relative;
      transition: border 0.18s;
      border: 2px solid transparent;
    }
    .dot.green {
      background: var(--dot-green);
    }
    .dot.orange {
      background: var(--dot-orange);
      cursor: pointer;
    }
    .dot.red {
      background: var(--dot-red);
    }
    .dot:focus, .dot:hover {
      outline: 2px solid var(--focus);
      border: 2px solid var(--accent);
    }
    .tooltip {
      display: block;
      position: absolute;
      left: 34px;
      background: #11141a;
      color: #e3e3e3;
      font-size: 0.94rem;
      padding: 3px 12px;
      border-radius: 5px;
      top: 50%;
      transform: translateY(-50%);
      white-space: nowrap;
      box-shadow: 0 2px 10px #0003;
      z-index: 2;
      pointer-events: none;
      opacity: 0.98;
      animation: fadein 0.13s;
      border: 1px solid #313b4c;
    }
    @keyframes fadein {
      from { opacity: 0; }
      to { opacity: 0.98; }
    }
    .current-block-progress-wrapper {
      margin: 16px 0 14px 0;
      padding: 1px 0;
    }
    .current-block-progress-label {
      font-size: 1em;
      color: var(--accent);
      font-weight: 600;
      margin-bottom: 4px;
      margin-left: 2px;
    }
    .current-block-progress-bar-bg {
      width: 100%;
      background: var(--block-progress-bg);
      height: 13px;
      border-radius: 7px;
      overflow: hidden;
      position: relative;
      margin-top: 4px;
      box-shadow: 0 1px 6px #0001;
    }
    .current-block-progress-bar-fill {
      background: var(--block-progress-fill);
      height: 100%;
      width: 0%;
      border-radius: 7px;
      transition: width 0.5s cubic-bezier(.44,2,.28,1);
    }
    .status-extras {
      padding: 7px 0 3px 0;
      margin-bottom: 2px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px 18px;
      justify-content: space-between;
      align-items: flex-start;
      border-top: 2px dashed var(--accent);
      border-radius: 7px;
      margin-top: 16px;
      background: #232a33;
    }
    .status-extra {
      flex: 1 1 150px;
      min-width: 140px;
      margin: 0;
      background: #262b35;
      color: var(--accent);
      border-radius: 8px;
      padding: 10px 9px 7px 12px;
      box-shadow: 0 1px 7px #0001;
      font-size: 1.04em;
      position: relative;
      text-align: left;
      transition: background 0.18s;
      min-height: 40px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .status-extra.block-time-left {
      flex: 2 1 320px;
      font-size: 1.3em;
      background: #212a36;
      color: var(--accent);
      text-align: center;
      align-items: center;
      justify-content: center;
      min-width: 200px;
      min-height: 65px;
      box-shadow: 0 3px 18px #0002;
      letter-spacing: 1.1px;
    }
    body.light .status-extra.block-time-left {
      background: #eaf3fc;
      color: #2b8af7;
    }
    body.light .status-extra {
      background: #eef4fb;
      color: #2b8af7;
    }
    .status-extra .extra-title {
      font-size: 0.97em;
      color: var(--accent);
      font-weight: 700;
      margin-bottom: 1px;
      letter-spacing: 0.5px;
    }
    .status-extra strong {
      color: #e3e3e3;
      font-size: 1.13em;
    }
    .status-extra .emoji {
      font-size: 1.25em;
      vertical-align: middle;
      margin-right: 4px;
    }
    .status-extra .copy-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 0.83em;
      padding: 1px 8px;
      cursor: pointer;
      font-weight: 700;
      margin-left: 9px;
      margin-top: 2px;
      transition: background 0.14s;
    }
    .status-extra .copy-btn:hover {
      background: #1664bb;
    }
    .status-extra .copied-msg {
      color: #41c65b;
      font-size: 0.86em;
      margin-left: 3px;
      font-style: italic;
    }
    .status-extra .block-picker {
      margin-top: 2px;
      font-size: 1em;
      border-radius: 5px;
      border: 1px solid #475065;
      background: #23272e;
      color: #e3e3e3;
      padding: 1px 4px;
    }
    .status-extra .block-picker:focus {
      outline: 2px solid var(--accent);
    }
    .status-extra .time {
      font-size: 1.02em;
      font-weight: 700;
      color: var(--accent);
      margin-top: 2px;
    }
    @media (max-width: 700px) {
      .status-extras { flex-direction: column; gap: 8px; }
      .status-extra, .status-extra.block-time-left { min-width: 80px; }
    }
    .fun-border {
      border: 2px dashed #2b8af7;
      padding: 3px;
      border-radius: 13px;
      margin: 12px 0;
      background: #20242a;
      animation: none;
    }
    .mood-bar {
      margin: 20px 0 0 0;
      text-align: center;
      background: var(--block-bg);
      border-radius: 11px;
      box-shadow: 0 2px 10px #0002;
      padding: 12px 0 11px 0;
      border: 1px solid #262a31;
    }
    .mood-bar label {
      margin-right: 9px;
      font-size: 1.1em;
      color: var(--accent);
      font-weight: 600;
    }
    .mood-btn {
      font-size: 1.6em;
      margin: 0 7px;
      cursor: pointer;
      border: none;
      background: transparent;
      transition: transform 0.12s;
      outline: none;
    }
    .mood-btn.selected, .mood-btn:focus {
      transform: scale(1.18);
      filter: brightness(1.25);
    }
    .mood-history {
      margin: 9px 0 0 0;
      font-size: 0.97em;
      color: var(--accent);
      font-weight: 500;
      min-height: 1.6em;
    }
    .restroom-status {
      text-align: center;
      margin: 13px 0 0 0;
      font-size: 1.25rem;
      padding: 10px 0;
      border-radius: 8px;
      font-weight: 700;
      letter-spacing: 1px;
      transition: background 0.2s, color 0.2s;
      background: #232a33;
      color: #2b8af7;
      border: 2px solid #2b8af7;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 1px 7px #0002;
      position: relative;
    }
    .restroom-status.unavailable {
      color: #f44336;
      background: #2a1c1c;
      border-color: #f44336;
      text-shadow: none;
    }
    .restroom-status.available {
      color: #41c65b;
      background: #1c2a1c;
      border-color: #41c65b;
      text-shadow: none;
    }
    .confetti-piece {
      position: fixed;
      top: 0;
      width: 12px;
      height: 12px;
      border-radius: 3px;
      opacity: 0.7;
      pointer-events: none;
      z-index: 9999;
      animation: confetti-fall 2.5s linear forwards;
    }
    @keyframes confetti-fall {
      to {
        transform: translateY(92vh) rotate(360deg);
        opacity: 0.25;
      }
    }
    /* Weather HAC styles */
    .weather-hac {
      margin: 18px 0 0 0;
      background: #232a33;
      border: 2px solid #2b8af7;
      border-radius: 10px;
      padding: 13px 15px 12px 15px;
      color: #2b8af7;
      font-size: 1.13em;
      text-align: center;
      font-weight: 700;
      letter-spacing: 1px;
      max-width: 420px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 1px 6px #0002;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .weather-hac.weather-ok {
      background: #203024;
      color: #41c65b;
      border-color: #41c65b;
      text-shadow: none;
    }
    .weather-hac.weather-rain {
      background: #2a1c1c;
      color: #f44336;
      border-color: #f44336;
      text-shadow: none;
    }
    .weather-hac .weather-hac-status {
      font-size: 1.14em;
      font-weight: 800;
      margin-top: 1px;
    }
    .weather-hac .weather-hac-detail {
      font-size: 0.98em;
      font-weight: 500;
      color: #7fa9ce;
      margin-top: 3px;
    }
    .weather-hac .weather-hac-btn {
      background: #232a33;
      color: #2b8af7;
      border: 1.5px solid #2b8af7;
      border-radius: 7px;
      font-size: 0.98em;
      padding: 3px 11px;
      margin-top: 4px;
      cursor: pointer;
      font-weight: 700;
      transition: background 0.17s, color 0.17s;
    }
    .weather-hac .weather-hac-btn:hover {
      background: #2b8af7;
      color: #fff;
      border-color: #2b8af7;
    }
  </style>
</head>
<body>
  <div class="bg-anim"></div>
  <div class="container">
    <button class="theme-switcher" id="theme-switcher">🌙 Theme</button>
    <h1>6th Grade Schedule</h1>
    <div class="progress-bar-container">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
    <div class="encouragement" id="encouragement"></div>
    <div class="schedule-header">Today's Blocks</div>
    <div class="schedule" id="schedule"></div>
    <div class="status" id="status">
      <h2>Status</h2>
      <div class="current-block-progress-wrapper" id="current-block-progress" style="display:none;">
        <div class="current-block-progress-label">Current Block Progress</div>
        <div class="current-block-progress-bar-bg">
          <div class="current-block-progress-bar-fill" id="current-block-progress-fill"></div>
        </div>
      </div>
      <div id="status-blocks"></div>
      <div class="status-extras" id="status-extras"></div>
    </div>
    <div class="restroom-status" id="restroom-status">
      Restroom: Unavailable
    </div>
    <!-- WEATHER HAC WIDGET, ADDED -->
    <div class="weather-hac" id="weather-hac">
      <span class="weather-hac-status">Checking weather for HAC...</span>
      <span class="weather-hac-detail"></span>
      <button class="weather-hac-btn" id="weather-hac-refresh" style="display:none;">↻ Refresh</button>
    </div>
    <div class="fun-border">
      <div class="mood-bar">
        <label>How are you feeling? </label>
        <button class="mood-btn" data-mood="😀" title="Happy">😀</button>
        <button class="mood-btn" data-mood="😐" title="Okay">😐</button>
        <button class="mood-btn" data-mood="😢" title="Sad">😢</button>
        <button class="mood-btn" data-mood="🤩" title="Awesome">🤩</button>
        <button class="mood-btn" data-mood="😴" title="Tired">😴</button>
        <div class="mood-history" id="mood-history"></div>
      </div>
    </div>
  </div>
  <div class="notes-modal-bg" id="notes-modal-bg" style="display:none;">
    <div class="notes-modal" id="notes-modal">
      <h2 id="notes-modal-title">Notes</h2>
      <textarea id="notes-modal-text"></textarea><br>
      <button class="close-notes" id="close-notes-btn">Close</button>
      <button class="save-notes" id="save-notes-btn">Save</button>
    </div>
  </div>
  <script>
    // ... all your JS ...
    const schedule = [
      { name: "Homeroom", start: "9:15", end: "9:56" },
      { name: "2nd Block", start: "9:58", end: "10:58" },
      { name: "3rd Block", start: "11:01", end: "11:56" },
      { name: "Lunch & HAC", start: "12:04", end: "13:04" },
      { name: "4th Block", start: "13:07", end: "14:07" },
      { name: "5th Block", start: "14:10", end: "15:10" },
      { name: "Electives", start: "15:13", end: "16:13" },
      { name: "Dismissal", start: "16:13", end: "17:00" },
    ];
    const encouragements = [
      "You got this! 🚀",
      "Keep up the great work! 💪",
      "You're making awesome progress! 🌟",
      "Stay positive and keep learning! 😎",
      "Take a deep breath and crush it! 🐉",
      "High five, you're doing great! 🙌",
      "Almost there! Keep going! 🏁",
      "Wow! You're on fire today! 🔥",
      "Proud of you! 🎉",
      "Believe in yourself, you are unstoppable! 🦸‍♂️"
    ];
    function to12h(time) {
      let [h, m] = time.split(":").map(Number);
      let ampm = h >= 12 ? "PM" : "AM";
      let h12 = h % 12; if (h12 === 0) h12 = 12;
      return `${h12}:${String(m).padStart(2,"0")} ${ampm}`;
    }
    const timeToSeconds = (time) => {
      const [hours, minutes] = time.split(":").map(Number);
      return hours * 3600 + minutes * 60;
    };
    function formatTime(secs) {
      if (secs <= 0) return "0m 00s";
      const m = Math.floor(secs / 60);
      const s = secs % 60;
      return `${m}m ${String(s).padStart(2, "0")}s`;
    }
    function getDayProgressPercent(nowSecs) {
      const start = timeToSeconds(schedule[0].start);
      const end = timeToSeconds(schedule[schedule.length-1].end);
      if (nowSecs <= start) return 0;
      if (nowSecs >= end) return 100;
      return ((nowSecs - start) / (end - start)) * 100;
    }
    // --- THEME SWITCHER ---
    const themeSwitcher = document.getElementById('theme-switcher');
    themeSwitcher.onclick = function() {
      document.body.classList.toggle('light');
      if (document.body.classList.contains('light')) {
        themeSwitcher.innerHTML = '🌞 Theme';
        localStorage.setItem('bm-theme', 'light');
      } else {
        themeSwitcher.innerHTML = '🌙 Theme';
        localStorage.setItem('bm-theme', 'dark');
      }
    };
    (function(){
      const theme = localStorage.getItem('bm-theme');
      if (theme === 'light') {
        document.body.classList.add('light');
        themeSwitcher.innerHTML = '🌞 Theme';
      }
    })();
    // --- BLOCK NOTES ---
    const notesBtnClass = 'notes-btn';
    const notesIndicatorClass = 'notes-indicator';
    function getNotesKey(blockName) {
      return 'bm-note-' + encodeURIComponent(blockName);
    }
    function getBlockNote(blockName) {
      return localStorage.getItem(getNotesKey(blockName)) || '';
    }
    function setBlockNote(blockName, text) {
      localStorage.setItem(getNotesKey(blockName), text);
    }
    function throwConfetti(lots = true) {
      const confettiCount = lots ? 44 : 12;
      for (let i = 0; i < confettiCount; i++) {
        const conf = document.createElement('div');
        conf.className = 'confetti-piece';
        conf.style.left = Math.random()*98+'vw';
        conf.style.background = `hsl(${Math.random()*360},80%,60%)`;
        conf.style.animationDelay = (Math.random()*0.8).toFixed(2)+'s';
        conf.style.transform = `rotate(${Math.random()*360}deg)`;
        document.body.appendChild(conf);
        setTimeout(()=>conf.remove(), 3000);
      }
    }
    let lastBlockIndex = -1;
    let time20mConfetti = {};
    let prevBlockIndex = -1;
    function showEncouragement() {
      const eDiv = document.getElementById('encouragement');
      eDiv.textContent = encouragements[Math.floor(Math.random()*encouragements.length)];
      eDiv.style.opacity = '1';
      setTimeout(()=>{eDiv.style.opacity='0.2';}, 4000);
    }
    const scheduleDiv = document.getElementById("schedule");
    scheduleDiv.innerHTML = '';
    schedule.forEach((block, idx) => {
      const blockDiv = document.createElement("div");
      blockDiv.classList.add("block");
      blockDiv.innerHTML = `
        <span>
          ${block.name}
          <span class="block-time">${to12h(block.start)} - ${to12h(block.end)}</span>
          <button class="${notesBtnClass}" data-block="${block.name}">📝 Notes</button>
          <span class="${notesIndicatorClass}" style="display:none;">✔</span>
        </span>
      `;
      scheduleDiv.appendChild(blockDiv);
    });
    const notesModalBg = document.getElementById('notes-modal-bg');
    const notesModal = document.getElementById('notes-modal');
    const notesModalTitle = document.getElementById('notes-modal-title');
    const notesModalText = document.getElementById('notes-modal-text');
    let currNotesBlock = '';
    scheduleDiv.addEventListener('click', function(e) {
      if (e.target.classList.contains(notesBtnClass)) {
        currNotesBlock = e.target.getAttribute('data-block');
        notesModalTitle.textContent = `Notes for ${currNotesBlock}`;
        notesModalText.value = getBlockNote(currNotesBlock);
        notesModalBg.style.display = 'flex';
        notesModalText.focus();
      }
    });
    document.getElementById('close-notes-btn').onclick = () => {
      notesModalBg.style.display = 'none';
      currNotesBlock = '';
    };
    document.getElementById('save-notes-btn').onclick = () => {
      setBlockNote(currNotesBlock, notesModalText.value);
      notesModalBg.style.display = 'none';
      currNotesBlock = '';
      updateNotesIndicators();
    };
    notesModalBg.onclick = function(e){
      if (e.target === notesModalBg) notesModalBg.style.display = 'none';
    };
    function updateNotesIndicators() {
      Array.from(document.getElementsByClassName(notesBtnClass)).forEach(btn=>{
        const block = btn.getAttribute('data-block');
        const indicator = btn.parentNode.querySelector('.'+notesIndicatorClass);
        indicator.style.display = getBlockNote(block).trim() ? '' : 'none';
      });
    }
    // --- TOOLTIP (for upcoming blocks) ---
    let tooltipInterval = null;
    function showTooltip(dot, secondsUntil, blockName) {
      removeTooltip();
      const tooltip = document.createElement("span");
      tooltip.className = "tooltip";
      tooltip.innerText = `Starts in: ${formatTime(secondsUntil)}`;
      dot.parentElement.appendChild(tooltip);
      let currSecs = secondsUntil;
      tooltipInterval = setInterval(() => {
        currSecs--;
        if (currSecs < 0) currSecs = 0;
        tooltip.innerText = `Starts in: ${formatTime(currSecs)}`;
        if (currSecs === 0) clearInterval(tooltipInterval);
      }, 1000);
    }
    function removeTooltip() {
      if (tooltipInterval) clearInterval(tooltipInterval);
      document.querySelectorAll('.tooltip').forEach(t => t.remove());
    }
    // --- TIMERS & STATUS ---
    const restroomStatusDisplay = document.getElementById("restroom-status");
    const progressBar = document.getElementById("progress-bar");
    const currentBlockProgress = document.getElementById("current-block-progress");
    const currentBlockProgressFill = document.getElementById("current-block-progress-fill");
    let previousCurrentBlockIndex = -1;
    function updateTimersAndStatus() {
      const now = new Date();
      const currentSeconds = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
      let currentBlock = null;
      let timeLeft = null;
      let currentBlockIndex = -1;
      let blockStart = null, blockEnd = null;
      progressBar.style.width = getDayProgressPercent(currentSeconds) + "%";
      const statusDiv = document.getElementById("status-blocks");
      statusDiv.innerHTML = "";
      schedule.forEach((block, index) => {
        const start = timeToSeconds(block.start);
        const end = timeToSeconds(block.end);
        const statusItem = document.createElement("div");
        statusItem.classList.add("status-block");
        let dotClass = "orange", tooltipSecs = start - currentSeconds;
        if (currentSeconds >= start && currentSeconds < end) {
          currentBlock = block;
          currentBlockIndex = index;
          timeLeft = end - currentSeconds;
          dotClass = "green";
          blockStart = start;
          blockEnd = end;
        } else if (currentSeconds >= end) {
          dotClass = "red";
        }
        statusItem.innerHTML = `<span tabindex="0" class="dot ${dotClass}"></span>${block.name}`;
        if (dotClass === "orange" && tooltipSecs > 0) {
          const dot = statusItem.querySelector('.dot');
          dot.onmouseenter = () => showTooltip(dot, tooltipSecs, block.name);
          dot.onmouseleave = removeTooltip;
          dot.onfocus = () => showTooltip(dot, tooltipSecs, block.name);
          dot.onblur = removeTooltip;
        }
        statusDiv.appendChild(statusItem);
      });
      if (currentBlock && blockStart !== null && blockEnd !== null && blockEnd > blockStart) {
        const total = blockEnd - blockStart;
        const elapsed = currentSeconds - blockStart;
        const percent = Math.max(0, Math.min(100, (elapsed / total) * 100));
        currentBlockProgress.style.display = "";
        if (currentBlockProgressFill) currentBlockProgressFill.style.width = percent + "%";
      } else {
        currentBlockProgress.style.display = "none";
        if (currentBlockProgressFill) currentBlockProgressFill.style.width = "0%";
      }

      // --- FIXED CONFETTI: Throw confetti when a block ENDS ---
      // Track which block was current previously, and which is now.
      // If the previous block is different and not -1, throw confetti!
      if (previousCurrentBlockIndex !== -1 && previousCurrentBlockIndex !== currentBlockIndex) {
        // Only if we switched to a new block or no block
        throwConfetti(true);
        showEncouragement();
        time20mConfetti = {};
      }
      previousCurrentBlockIndex = currentBlockIndex;

      // RESTROOM status logic
      if (currentBlock) {
        const blockDuration = blockEnd - blockStart;
        const timeSinceStart = blockDuration - timeLeft;
        const timeUntilEnd = timeLeft;
        if (timeSinceStart < 600) {
          restroomStatusDisplay.textContent = "Restroom: Unavailable (Wait 10 min after block start)";
          restroomStatusDisplay.className = "restroom-status unavailable";
        }
        else if (timeUntilEnd < 600) {
          restroomStatusDisplay.textContent = "Restroom: Unavailable (Less than 10 min left)";
          restroomStatusDisplay.className = "restroom-status unavailable";
        }
        else {
          restroomStatusDisplay.textContent = "Restroom: Available";
          restroomStatusDisplay.className = "restroom-status available";
        }
        document.title = `${currentBlock.name} - ${formatTime(timeLeft)} remaining`;
        // 20 minutes confetti (once per block)
        if (blockStart !== null && (currentSeconds - blockStart >= 1200) && !time20mConfetti[currentBlockIndex]) {
          throwConfetti(false); // small confetti
          time20mConfetti[currentBlockIndex] = true;
        }
      } else {
        restroomStatusDisplay.textContent = "Restroom: Unavailable";
        restroomStatusDisplay.className = "restroom-status unavailable";
        document.title = "Schedule";
      }
      updateStatusExtras(currentBlock, currentBlockIndex, timeLeft, now);
    }
    setInterval(updateTimersAndStatus, 1000);
    updateTimersAndStatus();
    updateNotesIndicators();
    function updateStatusExtras(currentBlock, currentBlockIndex, timeLeft, now) {
      const extras = document.getElementById("status-extras");
      let copyMsg = "";
      function copyBlockName() {
        if (currentBlock) {
          navigator.clipboard.writeText(currentBlock.name);
          copyMsg = "Copied!";
          showExtras();
          setTimeout(()=>{copyMsg="";showExtras();},1000);
        }
      }
      let timeLeftStr = currentBlock ? (
        timeLeft > 0
          ? `${Math.floor(timeLeft/3600)}h ${Math.floor((timeLeft%3600)/60)}m ${String(timeLeft%60).padStart(2,"0")}s`
          : "Done"
      ) : "N/A";
      const totalSecs = timeToSeconds(schedule[schedule.length-1].end) - timeToSeconds(schedule[0].start);
      const nowSecs = now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds();
      let progress = (nowSecs - timeToSeconds(schedule[0].start)) / totalSecs * 100;
      progress = Math.max(0, Math.min(100, progress));
      let emojiArr = ["😃","💪","🚀","🤩","😎","🌈","🔥","🎯","🍀","🦄","🌟","🏆"];
      let randomEmoji = localStorage.getItem("status-random-emoji") || emojiArr[0];
      function refreshEmoji() {
        randomEmoji = emojiArr[Math.floor(Math.random()*emojiArr.length)];
        localStorage.setItem("status-random-emoji", randomEmoji);
        showExtras();
      }
      function showExtras() {
        extras.innerHTML = `
          <div class="status-extra">
            <span class="extra-title">Current Block Name</span>
            <span><strong>${currentBlock ? currentBlock.name : 'None'}</strong>
              <button class="copy-btn" id="copy-block-btn">Copy</button>
              ${copyMsg ? `<span class="copied-msg">${copyMsg}</span>` : ""}
            </span>
          </div>
          <div class="status-extra block-time-left">
            <span class="extra-title" style="font-size:1.05em;">Block Time Left</span>
            <span class="time" style="font-size:1.45em;font-weight:800;">${timeLeftStr}</span>
          </div>
          <div class="status-extra">
            <span class="extra-title">Day Progress</span>
            <span class="time">${progress.toFixed(1)}%</span>
          </div>
          <div class="status-extra">
            <span class="extra-title">Motivation</span>
            <span class="emoji" id="refresh-emoji-btn" style="cursor:pointer;" title="Refresh">${randomEmoji}</span>
          </div>
        `;
        const copyBtn = document.getElementById("copy-block-btn");
        if (copyBtn) copyBtn.onclick = copyBlockName;
        const emojiBtn = document.getElementById("refresh-emoji-btn");
        if (emojiBtn) emojiBtn.onclick = refreshEmoji;
      }
      showExtras();
    }
    (function(){
      const moods = ["😀","😐","😢","🤩","😴"];
      const moodBtns = Array.from(document.getElementsByClassName("mood-btn"));
      const moodHistoryEl = document.getElementById("mood-history");
      function saveMood(mood) {
        let arr = [];
        try { arr = JSON.parse(localStorage.getItem("bm-mood-history")||"[]"); } catch {}
        arr.unshift({ mood, t: Date.now() });
        arr = arr.slice(0, 10);
        localStorage.setItem("bm-mood-history", JSON.stringify(arr));
        showMoodHistory();
      }
      function showMoodHistory() {
        let arr = [];
        try { arr = JSON.parse(localStorage.getItem("bm-mood-history")||"[]"); } catch {}
        if(arr.length){
          moodHistoryEl.textContent = "Recent: " + arr.slice(0,5).map(m=>m.mood).join(" ");
        } else {
          moodHistoryEl.textContent = "";
        }
        moodBtns.forEach(btn=>{
          btn.classList.remove("selected");
        });
        if(arr.length) {
          const current = arr[0].mood;
          moodBtns.forEach(btn=>{ if(btn.dataset.mood === current) btn.classList.add("selected"); });
        }
      }
      moodBtns.forEach(btn=>{
        btn.onclick = ()=>{ saveMood(btn.dataset.mood); };
      });
      showMoodHistory();
    })();

    // WEATHER HAC (Open-Meteo API, SMARTER HAC LOGIC)
    // Set this to your city/school coordinates!
    const WEATHER_LAT = 35.39602; // Set to your real location!
    const WEATHER_LON = -80.92412;
    const HAC_BLOCK = schedule.find(b => b.name.toLowerCase().includes("hac")) || { start: "12:04", end: "13:04" };
    function pad(n){ return n < 10 ? '0'+n : n; }
    function getTodayDateStr() {
      const d = new Date();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }
    function getHacHourMinutes() {
      let [starth, startm] = HAC_BLOCK.start.split(':').map(Number);
      let [endh, endm] = HAC_BLOCK.end.split(':').map(Number);
      return {starth, startm, endh, endm};
    }
    async function fetchWeatherHAC() {
      const weatherBox = document.getElementById("weather-hac");
      const status = weatherBox.querySelector(".weather-hac-status");
      const detail = weatherBox.querySelector(".weather-hac-detail");
      const btn = weatherBox.querySelector(".weather-hac-btn");
      weatherBox.className = "weather-hac";
      status.textContent = "Checking weather for HAC...";
      detail.textContent = "";
      btn.style.display = "none";
      try {
        const params =
          `latitude=${WEATHER_LAT}&longitude=${WEATHER_LON}` +
          `&hourly=precipitation_probability,precipitation` +
          `&daily=precipitation_sum,precipitation_hours` +
          `&forecast_days=1&timezone=auto`;
        const resp = await fetch("https://api.open-meteo.com/v1/forecast?" + params);
        const data = await resp.json();

        const {starth, startm, endh, endm} = getHacHourMinutes();

        // Find hourly forecast for HAC, for 1hr before, and for 1hr after
        let rainToday = false;
        let rainDuringHac = false;
        let rainBeforeHac = false;
        let rainAfterHac = false;
        let hacHours = [];
        let beforeHacHours = [];
        let afterHacHours = [];

        for(let i=0; i<data.hourly.time.length; ++i) {
          const t = new Date(data.hourly.time[i]);
          const hour = t.getHours();
          const min = t.getMinutes();
          // Rain at any hour today?
          if(data.hourly.precipitation_probability[i] > 50 || data.hourly.precipitation[i] > 0.05) {
            rainToday = true;
          }

          // Is this hour before HAC but within 1 hour?
          let before =
            (hour === starth && min < startm) ||
            (hour === starth-1) ||
            (hour === starth-2 && startm<15); // if HAC is near :00, include prev-2h if close to the hour

          // Is this hour after HAC but within 1 hour?
          let after =
            (hour === endh && min > endm) ||
            (hour === endh+1) ||
            (hour === endh+2 && endm>45); // if HAC ends near :59 include next+2h

          // During HAC?
          const inHac = (
            (hour > starth || (hour === starth && min >= startm)) &&
            (hour < endh || (hour === endh && min <= endm))
          );

          // Rain checks
          if (inHac) {
            hacHours.push({prob:data.hourly.precipitation_probability[i], amt:data.hourly.precipitation[i]});
            if(data.hourly.precipitation_probability[i] > 50 || data.hourly.precipitation[i] > 0.05) {
              rainDuringHac = true;
            }
          }
          if (before) {
            beforeHacHours.push({prob:data.hourly.precipitation_probability[i], amt:data.hourly.precipitation[i], hour, min});
            if(data.hourly.precipitation_probability[i] > 50 || data.hourly.precipitation[i] > 0.05) {
              rainBeforeHac = true;
            }
          }
          if (after) {
            afterHacHours.push({prob:data.hourly.precipitation_probability[i], amt:data.hourly.precipitation[i], hour, min});
            if(data.hourly.precipitation_probability[i] > 50 || data.hourly.precipitation[i] > 0.05) {
              rainAfterHac = true;
            }
          }
        }

        // Display logic
        if (rainDuringHac) {
          weatherBox.classList.add("weather-rain");
          status.textContent = "Rain expected during HAC 😕";
          let maxProb = Math.max(...hacHours.map(x=>x.prob));
          detail.textContent = `Rain chance during HAC: ${maxProb}%`;
        } else if (rainBeforeHac) {
          weatherBox.classList.add("weather-rain");
          status.textContent = "HAC inside today";
          let max = Math.max(...beforeHacHours.map(x=>x.prob));
          detail.textContent = `Rain is very close to HAC (chance: ${max}%)`;
        } else if (rainAfterHac) {
          weatherBox.classList.add("weather-ok");
          status.textContent = "You have outside HAC today (rain after HAC)";
          let max = Math.max(...afterHacHours.map(x=>x.prob));
          detail.textContent = `Rain expected after HAC (chance: ${max}%)`;
        } else if (!rainToday && !rainDuringHac && !rainBeforeHac && !rainAfterHac) {
          weatherBox.classList.add("weather-ok");
          status.textContent = "You can go outside for HAC!";
          detail.textContent = "No rain expected today. Have fun!";
        } else if(rainToday) {
          weatherBox.classList.add("weather-ok");
          status.textContent = "No rain during HAC!";
          detail.textContent = "It might rain at some other time today, but not during HAC.";
        } else {
          weatherBox.classList.add("weather-ok");
          status.textContent = "Weather data unavailable.";
        }
        btn.style.display = "";
      } catch(e) {
        weatherBox.classList.add("weather-rain");
        status.textContent = "Weather check failed.";
        detail.textContent = e && e.message ? e.message : e;
        btn.style.display = "";
      }
    }
    document.getElementById("weather-hac-refresh").onclick = fetchWeatherHAC;
    fetchWeatherHAC();
  </script>
</body>
</html>